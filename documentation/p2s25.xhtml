<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>com.io7m.r2 0.3.0-SNAPSHOT Documentation: 2.25. Environment Mapping</title><meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8"/><link rel="stylesheet" type="text/css" href="kstructural-layout.css"/><link rel="stylesheet" type="text/css" href="kstructural-colour.css"/><link rel="stylesheet" type="text/css" href="documentation.css"/></head><body><div class="st300_body"><div class="st300_navbar st300_navbar_top"><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_title_cell">2.24. Logarithmic Depth</td><td class="st300_navbar_up_title_cell">2. Design And Implementation</td><td class="st300_navbar_next_title_cell">2.26. Stippling</td></tr><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="p2s24.xhtml#st300_p2s24" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="p2.xhtml#st300_p2" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"><a rel="next" href="p2s26.xhtml#st300_p2s26" title="Go to next page">Next</a></td></tr></table><hr class="st300_hr"/></div><div class="st300_section_container"><a id="di.environment-mapping"/><div class="st300_section_title_number"><a id="st300_p2s25" href="#st300_p2s25" title="Section 2.25: Environment Mapping">2.25</a></div><div class="st300_section_title">Environment Mapping</div><ul class="st300_contents st300_section_contents_outer st300_section_contents"><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s25.xhtml#st300_p2s25ss1" title="Link to subsection 2.25.1: Overview">2.25.1. Overview</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s25.xhtml#st300_p2s25ss2" title="Link to subsection 2.25.2: Cube Maps">2.25.2. Cube Maps</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s25.xhtml#st300_p2s25ss3" title="Link to subsection 2.25.3: Reflections">2.25.3. Reflections</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s25.xhtml#st300_p2s25ss4" title="Link to subsection 2.25.4: Handedness">2.25.4. Handedness</a></li></ul><div class="st300_subsection_container"><a id="di.environment-mapping.overview"/><div class="st300_subsection_title_number"><a id="st300_p2s25ss1" href="#st300_p2s25ss1" title="Subsection 2.25.1: Overview">2.25.1</a></div><div class="st300_subsection_title">Overview</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss1c1" href="#st300_p2s25ss1c1" title="Paragraph 2.25.1.1">1</a></div><div class="st300_paragraph"><span class="st300_term term">Environment mapping</span> is conceptually the process of constructing an artificial environment around an object in order to provide, for example, effects such as reflective surfaces or refractive objects. In the <span class="st300_term package">r2</span> package, the artificial environment is represented by <a class="st300_link" href="p2s25.xhtml#di.environment-mapping.cube-maps">cube maps</a>, and the only provided effect is a simulation of <span class="st300_term reflection">reflection</span>. Effects such as refraction are instead provided via <a class="st300_link" href="p2s27.xhtml#di.generic-refraction">generic refraction</a>, which doesn't use environment mapping.</div></div></div><div class="st300_subsection_container"><a id="di.environment-mapping.cube-maps"/><div class="st300_subsection_title_number"><a id="st300_p2s25ss2" href="#st300_p2s25ss2" title="Subsection 2.25.2: Cube Maps">2.25.2</a></div><div class="st300_subsection_title">Cube Maps</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss2c1" href="#st300_p2s25ss2c1" title="Paragraph 2.25.2.1">1</a></div><div class="st300_paragraph">A <span class="st300_term term">cube map</span> is a <span class="st300_term term">texture</span> with six <span class="st300_term term">faces</span>. When used for environment mapping, each face represents a 90° image of the environment visible in the direction (in <a class="st300_link" href="p2s3.xhtml#di.coords.world">world space</a>) of that face. Cube maps are normally constructed by placing an observer in a scene and then orienting the observer in the direction of each cube face in turn and rendering an image. As an example:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s25ss2c2" href="#st300_p2s25ss2c2" title="Formal item 2.25.2.2: Cube map scene">2.25.2.2 Cube map scene</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Cube map scene" src="images/envmap_cube_scene.png"/></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss2c3" href="#st300_p2s25ss2c3" title="Paragraph 2.25.2.3">3</a></div><div class="st300_paragraph">Given the above scene, with the observer placed exactly in the center of the indicated magenta circle and assuming a 90° field of view, the six images visible from that location corresponding to the <span class="st300_term constant">-x</span>, <span class="st300_term constant">+x</span>, <span class="st300_term constant">-y</span>, <span class="st300_term constant">-z</span>, <span class="st300_term constant">-z</span>, <span class="st300_term constant">+z</span> cube faces are:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s25ss2c4" href="#st300_p2s25ss2c4" title="Formal item 2.25.2.4: Cube map example">2.25.2.4 Cube map example</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Cube map example" src="images/envmap_cubemap.png"/></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss2c5" href="#st300_p2s25ss2c5" title="Paragraph 2.25.2.5">5</a></div><div class="st300_paragraph">While sampling from ordinary two-dimensional textures involves looking up texels by their two-dimensional coordinates, sampling from cube maps requires three-dimensional coordinates. The three-dimensional coordinates are interpreted as a direction vector or ray emanating from the center of the cube, and the point of intersection between the ray and the corresponding cube face is used to select a texel from that face. Note that in OpenGL there are issues with <a class="st300_link" href="p2s25.xhtml#di.environment-mapping.handedness">coordinate system handedness</a> that the <span class="st300_term package">r2</span> package corrects.</div></div></div><div class="st300_subsection_container"><a id="di.environment-mapping.reflection"/><div class="st300_subsection_title_number"><a id="st300_p2s25ss3" href="#st300_p2s25ss3" title="Subsection 2.25.3: Reflections">2.25.3</a></div><div class="st300_subsection_title">Reflections</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss3c1" href="#st300_p2s25ss3c1" title="Paragraph 2.25.3.1">1</a></div><div class="st300_paragraph">So-called <span class="st300_term term">environment-mapped reflections</span> are trivially provided by cube maps. For a given surface with a normal vector <span class="st300_term variable">n</span>, and given the view direction <span class="st300_term variable">v</span> (from the observer to the surface), a <span class="st300_term term">reflection vector</span> is given by <span class="st300_term expression">r = Reflection.reflection v n</span>:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s25ss3c2" href="#st300_p2s25ss3c2" title="Formal item 2.25.3.2: Reflection vector">2.25.3.2 Reflection vector</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">module Reflection where

import qualified Vector3f as V3

reflection :: V3.T -&gt; V3.T -&gt; V3.T
reflection v0 v1 = V3.sub3 v0 (V3.scale v1 (2.0 * (V3.dot3 v1 v0)))
</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss3c3" href="#st300_p2s25ss3c3" title="Paragraph 2.25.3.3">3</a></div><div class="st300_paragraph">The reflection vector <span class="st300_term variable">r</span> is then used to look up a texel in the current cube map directly. This gives a convincing illusion of reflection that will change as the observer moves relative to the surface. Combining normal mapping and environment mapped reflections gives a striking effect:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s25ss3c4" href="#st300_p2s25ss3c4" title="Formal item 2.25.3.4: Normal/Environment mapping">2.25.3.4 Normal/Environment mapping</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Normal/Environment mapping" src="images/envmap_tiles.png"/></div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s25ss3c5" href="#st300_p2s25ss3c5" title="Formal item 2.25.3.5: Normal/Environment mapping (Cube map)">2.25.3.5 Normal/Environment mapping (Cube map)</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Normal/Environment mapping (Cube map)" src="images/envmap_toronto.png"/></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss3c6" href="#st300_p2s25ss3c6" title="Paragraph 2.25.3.6">6</a></div><div class="st300_paragraph">Note that in the actual <span class="st300_term package">r2</span> implementation, the vectors <span class="st300_term variable">n</span> and <span class="st300_term variable">v</span> will be in eye-space and therefore so will <span class="st300_term variable">r</span>. The vector <span class="st300_term variable">r</span> is transformed back to <a class="st300_link" href="p2s3.xhtml#di.coords.world">world space</a> by the inverse of the current view matrix for use with the cube map.</div></div></div><div class="st300_subsection_container"><a id="di.environment-mapping.handedness"/><div class="st300_subsection_title_number"><a id="st300_p2s25ss4" href="#st300_p2s25ss4" title="Subsection 2.25.4: Handedness">2.25.4</a></div><div class="st300_subsection_title">Handedness</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s25ss4c1" href="#st300_p2s25ss4c1" title="Paragraph 2.25.4.1">1</a></div><div class="st300_paragraph">For reasons lost to time, cube maps in OpenGL use a left-handed coordinate system in contrast to the usual right-handed coordinate system. Because of this, calculated reflection vectors actually have to be inverted to prevent sampling from the wrong cube face. The <span class="st300_term package">r2</span> package enforces a consistent right-handed coordinate system everywhere. The direction of each cube face corresponds to the same direction in <a class="st300_link" href="p2s3.xhtml#di.coords.world">world space</a>, without exception.</div></div></div></div><div class="st300_navbar st300_navbar_bottom"><hr class="st300_hr"/><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="p2s24.xhtml#st300_p2s24" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="p2.xhtml#st300_p2" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"><a rel="next" href="p2s26.xhtml#st300_p2s26" title="Go to next page">Next</a></td></tr><tr><td class="st300_navbar_prev_title_cell">2.24. Logarithmic Depth</td><td class="st300_navbar_up_title_cell">2. Design And Implementation</td><td class="st300_navbar_next_title_cell">2.26. Stippling</td></tr></table></div></div></body></html>
