<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>io7m-r2 0.2.1 Documentation: 2.17. Shadows: Variance Mapping</title><meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8"/><link rel="stylesheet" type="text/css" href="kstructural-layout.css"/><link rel="stylesheet" type="text/css" href="kstructural-colour.css"/><link rel="stylesheet" type="text/css" href="documentation.css"/></head><body><div class="st300_body"><div class="st300_navbar st300_navbar_top"><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_title_cell">2.16. Shadows</td><td class="st300_navbar_up_title_cell">2. Design And Implementation</td><td class="st300_navbar_next_title_cell">2.18. Deferred Rendering</td></tr><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="p2s16.xhtml#st300_p2s16" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="p2.xhtml#st300_p2" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"><a rel="next" href="p2s18.xhtml#st300_p2s18" title="Go to next page">Next</a></td></tr></table><hr class="st300_hr"/></div><div class="st300_section_container"><a id="di.shadows.variance"/><div class="st300_section_title_number"><a id="st300_p2s17" href="#st300_p2s17" title="Section 2.17: Shadows: Variance Mapping">2.17</a></div><div class="st300_section_title">Shadows: Variance Mapping</div><ul class="st300_contents st300_section_contents_outer st300_section_contents"><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s17.xhtml#st300_p2s17ss1" title="Link to subsection 2.17.1: Overview">2.17.1. Overview</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s17.xhtml#st300_p2s17ss2" title="Link to subsection 2.17.2: Algorithm">2.17.2. Algorithm</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s17.xhtml#st300_p2s17ss3" title="Link to subsection 2.17.3: Advantages">2.17.3. Advantages</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s17.xhtml#st300_p2s17ss4" title="Link to subsection 2.17.4: Disadvantages">2.17.4. Disadvantages</a></li><li class="st300_contents_item st300_contents_item1 st300_contents_item_subsection"><a href="p2s17.xhtml#st300_p2s17ss5" title="Link to subsection 2.17.5: Types">2.17.5. Types</a></li></ul><div class="st300_subsection_container"><a id="di.shadows.variance.overview"/><div class="st300_subsection_title_number"><a id="st300_p2s17ss1" href="#st300_p2s17ss1" title="Subsection 2.17.1: Overview">2.17.1</a></div><div class="st300_subsection_title">Overview</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss1c1" href="#st300_p2s17ss1c1" title="Paragraph 2.17.1.1">1</a></div><div class="st300_paragraph"><span class="st300_term term">Variance shadow mapping</span> is a technique that can give attractive soft-edged shadows. Using the same view and projection matrices used to apply <a class="st300_link" href="p2s15.xhtml#di.lighting.projective">projective lights</a>, a <span class="st300_term term">depth-variance</span> image of the current scene is rendered, and those stored depth distribution values are used to determine the probability that a given point in the scene is in shadow with respect to the current light.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss1c2" href="#st300_p2s17ss1c2" title="Paragraph 2.17.1.2">2</a></div><div class="st300_paragraph">The algorithm implemented in the <span class="st300_term package">r2</span> package is described in <a class="st300_link_external" href="http://http.developer.nvidia.com/GPUGems3/gpugems3_ch08.html">GPU Gems 3</a>, which is a set of improvements to the original variance shadow mapping algorithm by William Donnelly and Andrew Lauritzen. The <span class="st300_term package">r2</span> package implements all of the improvements to the algorithm except <span class="st300_term term">summed area tables</span>. The package also provides optional box blurring of shadows as described in the chapter.</div></div></div><div class="st300_subsection_container"><a id="di.shadows.variance.algorithm"/><div class="st300_subsection_title_number"><a id="st300_p2s17ss2" href="#st300_p2s17ss2" title="Subsection 2.17.2: Algorithm">2.17.2</a></div><div class="st300_subsection_title">Algorithm</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c1" href="#st300_p2s17ss2c1" title="Paragraph 2.17.2.1">1</a></div><div class="st300_paragraph">Prior to actually <a class="st300_link" href="p2s18.xhtml#di.deferred">rendering</a>  a scene, <span class="st300_term term">shadow maps</span> are generated for all <span class="st300_term term">shadow-projecting</span> lights in the scene. A <span class="st300_term term">shadow map</span> for variance shadow mapping, for a light <span class="st300_term expression">k</span>, is a two-component red/green image of all of the <a class="st300_link" href="p2s16.xhtml#di.shadows.shadow-geometry">shadow casters</a> associated with <span class="st300_term expression">k</span> in the visible set. The image is produced by rendering the instances from the point of view of <span class="st300_term expression">k</span>. The red channel of each pixel in the image represents the <a class="st300_link" href="p2s24.xhtml#di.log_depth">logarithmic depth</a> of the closest surface at that pixel, and the green channel represents the depth squared (literally <span class="st300_term expression">depth * depth</span> ). For example:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c2" href="#st300_p2s17ss2c2" title="Formal item 2.17.2.2: Depth-variance image">2.17.2.2 Depth-variance image</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Depth-variance image" src="images/depth_variance.png"/></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c3" href="#st300_p2s17ss2c3" title="Paragraph 2.17.2.3">3</a></div><div class="st300_paragraph">Then, when actually applying lighting during rendering of the scene, a given <a class="st300_link" href="p2s3.xhtml#di.coords.eye">eye space</a> position <span class="st300_term expression">p</span> is transformed to <a class="st300_link" href="p2s15.xhtml#di.lighting.projective.algorithm">light-clip space</a> and then mapped to the range <span class="st300_term expression">[(0, 0, 0), (1, 1, 1)]</span> in order to sample the <span class="st300_term term">depth</span> and <span class="st300_term term">depth squared</span> values <span class="st300_term expression">(d, ds)</span> from the shadow map (as with sampling from a projected texture with projective lighting).</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c4" href="#st300_p2s17ss2c4" title="Paragraph 2.17.2.4">4</a></div><div class="st300_paragraph">As stated previously, the intent of variance shadow mapping is to essentially calculate the <span class="st300_term term">probability</span> that a given point is in shadow. A <span class="st300_term term">one-tailed</span> variant of <a class="st300_link_external" href="https://en.wikipedia.org/wiki/Chebyshev%27s_inequality">Chebyshev's inequality</a> is used to calculate the upper bound <span class="st300_term expression">u</span> on the probability that, given <span class="st300_term expression">(d, ds)</span>, a given point with depth <span class="st300_term expression">t</span> is in shadow:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c5" href="#st300_p2s17ss2c5" title="Formal item 2.17.2.5: Chebyshev 0">2.17.2.5 Chebyshev 0</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">module ShadowVarianceChebyshev0 where

chebyshev :: (Float, Float) -&gt; Float -&gt; Float
chebyshev (d, ds) t =
  let p        = if t &lt;= d then 1.0 else 0.0
      variance = ds - (d * d)
      du       = t - d
      p_max    = variance / (variance + (du * du))
  in max p p_max

factor :: (Float, Float) -&gt; Float -&gt; Float
factor = chebyshev
</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c6" href="#st300_p2s17ss2c6" title="Paragraph 2.17.2.6">6</a></div><div class="st300_paragraph">One of the improvements suggested to the original variance shadow algorithm is to clamp the minimum variance to some small value (the <span class="st300_term package">r2</span> package uses <span class="st300_term constant">0.00002</span> by default, but this is configurable on a per-shadow basis). The equation above becomes:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c7" href="#st300_p2s17ss2c7" title="Formal item 2.17.2.7: Chebyshev 1">2.17.2.7 Chebyshev 1</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">module ShadowVarianceChebyshev1 where

data T = T {
  minimum_variance :: Float
} deriving (Eq, Show)

chebyshev :: (Float, Float) -&gt; Float -&gt; Float -&gt; Float
chebyshev (d, ds) min_variance t =
  let p        = if t &lt;= d then 1.0 else 0.0
      variance = max (ds - (d * d)) min_variance
      du       = t - d
      p_max    = variance / (variance + (du * du))
  in max p p_max

factor :: T -&gt; (Float, Float) -&gt; Float -&gt; Float
factor shadow (d, ds) t =
  chebyshev (d, ds) (minimum_variance shadow) t
</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c8" href="#st300_p2s17ss2c8" title="Paragraph 2.17.2.8">8</a></div><div class="st300_paragraph">The above is sufficient to give shadows that are roughly equivalent in visual quality to basic shadow mapping with the added benefit of being generally better behaved and with far fewer artifacts. However, the algorithm can suffer from <span class="st300_term term">light bleeding</span>, where the penumbrae of overlapping shadows can be unexpectedly bright despite the fact that the entire area should be in shadow. One of the suggested improvements to reduce light bleeding is to modify the upper bound <span class="st300_term expression">u</span> such that all values below a configurable threshold are mapped to zero, and values above the threshold are rescaled to map them to the range <span class="st300_term expression">[0, 1]</span>. The original article suggests a linear step function applied to <span class="st300_term expression">u</span>:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c9" href="#st300_p2s17ss2c9" title="Formal item 2.17.2.9: Chebyshev 2">2.17.2.9 Chebyshev 2</a></div><div class="st300_formal_item_content"><pre class="st300_verbatim">module ShadowVarianceChebyshev2 where

data T = T {
  minimum_variance :: Float,
  bleed_reduction  :: Float
} deriving (Eq, Show)

chebyshev :: (Float, Float) -&gt; Float -&gt; Float -&gt; Float
chebyshev (d, ds) min_variance t =
  let p        = if t &lt;= d then 1.0 else 0.0
      variance = max (ds - (d * d)) min_variance
      du       = t - d
      p_max    = variance / (variance + (du * du))
  in max p p_max

clamp :: Float -&gt; (Float, Float) -&gt; Float
clamp x (lower, upper) = max (min x upper) lower

linear_step :: Float -&gt; Float -&gt; Float -&gt; Float
linear_step lower upper x = clamp ((x - lower) / (upper - lower)) (0.0, 1.0)

factor :: T -&gt; (Float, Float) -&gt; Float -&gt; Float
factor shadow (d, ds) t =
  let u = chebyshev (d, ds) (minimum_variance shadow) t in
    linear_step (bleed_reduction shadow) 1.0 u
</pre></div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c10" href="#st300_p2s17ss2c10" title="Paragraph 2.17.2.10">10</a></div><div class="st300_paragraph">The amount of light bleed reduction is adjustable on a per-shadow basis.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c11" href="#st300_p2s17ss2c11" title="Paragraph 2.17.2.11">11</a></div><div class="st300_paragraph">To reduce problems involving numeric inaccuracy, the original article suggests the use of 32-bit floating point textures in depth variance maps. The <span class="st300_term package">r2</span> package allows 16-bit or 32-bit textures, configurable on a per-shadow basis.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss2c12" href="#st300_p2s17ss2c12" title="Paragraph 2.17.2.12">12</a></div><div class="st300_paragraph">Finally, as mentioned previously, the <span class="st300_term package">r2</span> package allows both optional box blurring and mipmap generation for shadow maps. Both blurring and mipmapping can reduce aliasing artifacts, with the former also allowing the edges of shadows to be significantly softened as a visual effect:</div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c13" href="#st300_p2s17ss2c13" title="Formal item 2.17.2.13: Depth-variance shadows (Minimal blur)">2.17.2.13 Depth-variance shadows (Minimal blur)</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Depth-variance shadows (Minimal blur)" src="images/variance_0.png"/></div></div><div class="st300_formal_item"><div class="st300_formal_item_title"><a id="st300_p2s17ss2c14" href="#st300_p2s17ss2c14" title="Formal item 2.17.2.14: Depth-variance shadows (High blur)">2.17.2.14 Depth-variance shadows (High blur)</a></div><div class="st300_formal_item_content"><img class="st300_image" alt="Depth-variance shadows (High blur)" src="images/variance_1.png"/></div></div></div><div class="st300_subsection_container"><a id="di.shadows.variance.advantages"/><div class="st300_subsection_title_number"><a id="st300_p2s17ss3" href="#st300_p2s17ss3" title="Subsection 2.17.3: Advantages">2.17.3</a></div><div class="st300_subsection_title">Advantages</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss3c1" href="#st300_p2s17ss3c1" title="Paragraph 2.17.3.1">1</a></div><div class="st300_paragraph">The main advantage of <span class="st300_term term">variance shadow mapping</span> is that they can essentially be thought of as much better behaved version of basic shadow mapping that just happen to have built-in softening and filtering. Variance shadows typically require far less in the way of scene-specific tuning to get good results.</div></div></div><div class="st300_subsection_container"><a id="di.shadows.variance.disadvantages"/><div class="st300_subsection_title_number"><a id="st300_p2s17ss4" href="#st300_p2s17ss4" title="Subsection 2.17.4: Disadvantages">2.17.4</a></div><div class="st300_subsection_title">Disadvantages</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss4c1" href="#st300_p2s17ss4c1" title="Paragraph 2.17.4.1">1</a></div><div class="st300_paragraph">One disadvantage of variance shadows is that for large shadow maps, filtering quickly becomes a major bottleneck. On reasonably old hardware such as the <a class="st300_link_external" href="https://en.wikipedia.org/wiki/Radeon_HD_4670">Radeon 4670</a>, one <span class="st300_term constant">8192x8192</span> shadow map with two 16-bit components takes too long to filter to give a reliable <span class="st300_term constant">60</span> frames per second rendering rate. Shadow maps of this size are usually used to simulate the influence of the sun over large outdoor scenes.</div></div></div><div class="st300_subsection_container"><a id="di.shadows.variance.types"/><div class="st300_subsection_title_number"><a id="st300_p2s17ss5" href="#st300_p2s17ss5" title="Subsection 2.17.5: Types">2.17.5</a></div><div class="st300_subsection_title">Types</div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss5c1" href="#st300_p2s17ss5c1" title="Paragraph 2.17.5.1">1</a></div><div class="st300_paragraph">Variance mapped shadows are represented by the <a class="st300_link_external" href="apidocs/com/io7m/r1/core/R2ShadowDepthVarianceType.html">R2ShadowDepthVarianceType</a> type, and can be associated with <a class="st300_link" href="p2s15.xhtml#di.lighting.projective">projective lights</a>.</div></div><div class="st300_paragraph_container"><div class="st300_paragraph_number"><a id="st300_p2s17ss5c2" href="#st300_p2s17ss5c2" title="Paragraph 2.17.5.2">2</a></div><div class="st300_paragraph">Rendering of depth-variance images is handled by implementations of the <a class="st300_link_external" href="apidocs/com/io7m/r1/core/R2ShadowMapRendererType.html">R2ShadowMapRendererType</a> type.</div></div></div></div><div class="st300_navbar st300_navbar_bottom"><hr class="st300_hr"/><table class="st300_navbar_table" summary="st300_Navigation bar"><tr><td class="st300_navbar_prev_file_cell"><a rel="previous" href="p2s16.xhtml#st300_p2s16" title="Go to previous page">Previous</a></td><td class="st300_navbar_up_file_cell"><a rel="up" href="p2.xhtml#st300_p2" title="Go to parent page">Up</a></td><td class="st300_navbar_next_file_cell"><a rel="next" href="p2s18.xhtml#st300_p2s18" title="Go to next page">Next</a></td></tr><tr><td class="st300_navbar_prev_title_cell">2.16. Shadows</td><td class="st300_navbar_up_title_cell">2. Design And Implementation</td><td class="st300_navbar_next_title_cell">2.18. Deferred Rendering</td></tr></table></div></div></body></html>
